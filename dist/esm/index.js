import e,{useRef as t,useState as s,useEffect as n,startTransition as r}from"react";import{TrianglesDrawMode as o,TriangleFanDrawMode as i,TriangleStripDrawMode as a,Loader as c,LoaderUtils as l,FileLoader as u,Color as h,SpotLight as d,PointLight as m,DirectionalLight as p,MeshBasicMaterial as f,SRGBColorSpace as g,MeshPhysicalMaterial as A,Vector2 as T,Matrix4 as x,Vector3 as R,Quaternion as E,InstancedMesh as v,Object3D as _,TextureLoader as w,ImageBitmapLoader as y,BufferAttribute as b,InterleavedBuffer as M,InterleavedBufferAttribute as S,LinearFilter as L,LinearMipmapLinearFilter as I,RepeatWrapping as N,PointsMaterial as O,Material as C,LineBasicMaterial as P,MeshStandardMaterial as H,DoubleSide as k,PropertyBinding as D,BufferGeometry as F,SkinnedMesh as B,Mesh as G,LineSegments as U,Line as j,LineLoop as K,Points as V,Group as X,PerspectiveCamera as q,MathUtils as z,OrthographicCamera as Y,Skeleton as W,AnimationClip as Q,Bone as Z,InterpolateLinear as J,NearestFilter as $,NearestMipmapNearestFilter as ee,LinearMipmapNearestFilter as te,NearestMipmapLinearFilter as se,ClampToEdgeWrapping as ne,MirroredRepeatWrapping as re,InterpolateDiscrete as oe,FrontSide as ie,Texture as ae,VectorKeyframeTrack as ce,NumberKeyframeTrack as le,QuaternionKeyframeTrack as ue,Box3 as he,Sphere as de,Interpolant as me}from"three";import{useFrame as pe}from"@react-three/fiber";import{useSpring as fe,config as ge,animated as Ae}from"@react-spring/three";var Te=function(){return Te=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++)for(var r in t=arguments[s])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},Te.apply(this,arguments)};function xe(e,t){if(t===o)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===i||t===a){let s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const n=s.count-2,r=[];if(t===i)for(let e=1;e<=n;e++)r.push(s.getX(0)),r.push(s.getX(e)),r.push(s.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(r.push(s.getX(e)),r.push(s.getX(e+1)),r.push(s.getX(e+2))):(r.push(s.getX(e+2)),r.push(s.getX(e+1)),r.push(s.getX(e)));r.length/3!==n&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=e.clone();return o.setIndex(r),o.clearGroups(),o}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}"function"==typeof SuppressedError&&SuppressedError;function Re(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const Ee={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class ve{constructor(e){this.parser=e,this.name=Ee.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const r=t.json,o=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let i;const a=new h(16777215);void 0!==o.color&&a.fromArray(o.color);const c=void 0!==o.range?o.range:0;switch(o.type){case"directional":i=new p(a),i.target.position.set(0,0,-1),i.add(i.target);break;case"point":i=new m(a),i.distance=c;break;case"spot":i=new d(a),i.distance=c,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,i.angle=o.spot.outerConeAngle,i.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,i.target.position.set(0,0,-1),i.add(i.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return i.position.set(0,0,0),i.decay=2,it(i,o),void 0!==o.intensity&&(i.intensity=o.intensity),i.name=t.createUniqueName(o.name||"light_"+e),n=Promise.resolve(i),t.cache.add(s,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],r=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then((function(e){return s._getNodeRef(t.cache,r,e)}))}}class _e{constructor(){this.name=Ee.KHR_MATERIALS_UNLIT}getMaterialType(){return f}extendParams(e,t,s){const n=[];e.color=new h(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==r.baseColorTexture&&n.push(s.assignTexture(e,"map",r.baseColorTexture,g))}return Promise.all(n)}}class we{constructor(e){this.parser=e,this.name=Ee.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name].emissiveStrength;return void 0!==n&&(t.emissiveIntensity=n),Promise.resolve()}}class ye{constructor(e){this.parser=e,this.name=Ee.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?A:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&r.push(s.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(r.push(s.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new T(e,e)}return Promise.all(r)}}class be{constructor(e){this.parser=e,this.name=Ee.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?A:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&r.push(s.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&r.push(s.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(r)}}class Me{constructor(e){this.parser=e,this.name=Ee.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?A:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new h(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];return void 0!==o.sheenColorFactor&&t.sheenColor.fromArray(o.sheenColorFactor),void 0!==o.sheenRoughnessFactor&&(t.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&r.push(s.assignTexture(t,"sheenColorMap",o.sheenColorTexture,g)),void 0!==o.sheenRoughnessTexture&&r.push(s.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(r)}}class Se{constructor(e){this.parser=e,this.name=Ee.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?A:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&r.push(s.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class Le{constructor(e){this.parser=e,this.name=Ee.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?A:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];t.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&r.push(s.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const i=o.attenuationColor||[1,1,1];return t.attenuationColor=new h(i[0],i[1],i[2]),Promise.all(r)}}class Ie{constructor(e){this.parser=e,this.name=Ee.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?A:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class Ne{constructor(e){this.parser=e,this.name=Ee.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?A:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];t.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&r.push(s.assignTexture(t,"specularIntensityMap",o.specularTexture));const i=o.specularColorFactor||[1,1,1];return t.specularColor=new h(i[0],i[1],i[2]),void 0!==o.specularColorTexture&&r.push(s.assignTexture(t,"specularColorMap",o.specularColorTexture,g)),Promise.all(r)}}class Oe{constructor(e){this.parser=e,this.name=Ee.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?A:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&r.push(s.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(r)}}class Ce{constructor(e){this.parser=e,this.name=Ee.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const r=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,o)}}class Pe{constructor(e){this.parser=e,this.name=Ee.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],i=n.images[o.source];let a=s.textureLoader;if(i.uri){const e=s.options.manager.getHandler(i.uri);null!==e&&(a=e)}return this.detectSupport().then((function(r){if(r)return s.loadTextureImage(e,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class He{constructor(e){this.parser=e,this.name=Ee.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],i=n.images[o.source];let a=s.textureLoader;if(i.uri){const e=s.options.manager.getHandler(i.uri);null!==e&&(a=e)}return this.detectSupport().then((function(r){if(r)return s.loadTextureImage(e,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class ke{constructor(e){this.name=Ee.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then((function(t){const s=e.byteOffset||0,n=e.byteLength||0,o=e.count,i=e.byteStride,a=new Uint8Array(t,s,n);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(o,i,a,e.mode,e.filter).then((function(e){return e.buffer})):r.ready.then((function(){const t=new ArrayBuffer(o*i);return r.decodeGltfBuffer(new Uint8Array(t),o,i,a,e.mode,e.filter),t}))}))}return null}}class De{constructor(e){this.name=Ee.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;const n=t.meshes[s.mesh];for(const e of n.primitives)if(e.mode!==Ye.TRIANGLES&&e.mode!==Ye.TRIANGLE_STRIP&&e.mode!==Ye.TRIANGLE_FAN&&void 0!==e.mode)return null;const r=s.extensions[this.name].attributes,o=[],i={};for(const e in r)o.push(this.parser.getDependency("accessor",r[e]).then((t=>(i[e]=t,i[e]))));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then((e=>{const t=e.pop(),s=t.isGroup?t.children:[t],n=e[0].count,r=[];for(const e of s){const t=new x,s=new R,o=new E,a=new R(1,1,1),c=new v(e.geometry,e.material,n);for(let e=0;e<n;e++)i.TRANSLATION&&s.fromBufferAttribute(i.TRANSLATION,e),i.ROTATION&&o.fromBufferAttribute(i.ROTATION,e),i.SCALE&&a.fromBufferAttribute(i.SCALE,e),c.setMatrixAt(e,t.compose(s,o,a));for(const t in i)"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,i[t]);_.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),r.push(c)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]})))}}const Fe="glTF",Be=1313821514,Ge=5130562;class Ue{constructor(e){this.name=Ee.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Fe)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,r=new DataView(e,12);let o=0;for(;o<n;){const t=r.getUint32(o,!0);o+=4;const n=r.getUint32(o,!0);if(o+=4,n===Be){const n=new Uint8Array(e,12+o,t);this.content=s.decode(n)}else if(n===Ge){const s=12+o;this.body=e.slice(s,s+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class je{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Ee.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,r=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,i={},a={},c={};for(const e in o){const t=$e[e]||e.toLowerCase();i[t]=o[e]}for(const t in e.attributes){const n=$e[t]||t.toLowerCase();if(void 0!==o[t]){const r=s.accessors[e.attributes[t]],o=We[r.componentType];c[n]=o.name,a[n]=!0===r.normalized}}return t.getDependency("bufferView",r).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(const t in e.attributes){const s=e.attributes[t],n=a[t];void 0!==n&&(s.normalized=n)}t(e)}),i,c)}))}))}}class Ke{constructor(){this.name=Ee.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Ve{constructor(){this.name=Ee.KHR_MESH_QUANTIZATION}}class Xe extends me{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,r=e*n*3+n;for(let e=0;e!==n;e++)t[e]=s[r+e];return t}interpolate_(e,t,s,n){const r=this.resultBuffer,o=this.sampleValues,i=this.valueSize,a=2*i,c=3*i,l=n-t,u=(s-t)/l,h=u*u,d=h*u,m=e*c,p=m-c,f=-2*d+3*h,g=d-h,A=1-f,T=g-h+u;for(let e=0;e!==i;e++){const t=o[p+e+i],s=o[p+e+a]*l,n=o[m+e+i],c=o[m+e]*l;r[e]=A*t+T*s+f*n+g*c}return r}}const qe=new E;class ze extends Xe{interpolate_(e,t,s,n){const r=super.interpolate_(e,t,s,n);return qe.fromArray(r).normalize().toArray(r),r}}const Ye={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},We={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Qe={9728:$,9729:L,9984:ee,9985:te,9986:se,9987:I},Ze={33071:ne,33648:re,10497:N},Je={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},$e={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},et={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},tt={CUBICSPLINE:void 0,LINEAR:J,STEP:oe},st="OPAQUE",nt="MASK",rt="BLEND";function ot(e,t,s){for(const n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function it(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function at(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function ct(e){let t;const s=e.extensions&&e.extensions[Ee.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+lt(s.attributes):e.indices+":"+lt(e.attributes)+":"+e.mode,void 0!==e.targets)for(let s=0,n=e.targets.length;s<n;s++)t+=":"+lt(e.targets[s]);return t}function lt(e){let t="";const s=Object.keys(e).sort();for(let n=0,r=s.length;n<r;n++)t+=s[n]+":"+e[s[n]]+";";return t}function ut(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const ht=new x;class dt{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Re,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=!1,r=-1;"undefined"!=typeof navigator&&(s=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=navigator.userAgent.indexOf("Firefox")>-1,r=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||s||n&&r<98?this.textureLoader=new w(this.options.manager):this.textureLoader=new y(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new u(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])})).then((function(t){const o={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:s,userData:{}};ot(r,o,n),it(o,n),Promise.all(s._invokeAll((function(e){return e.afterRoot&&e.afterRoot(o)}))).then((function(){e(o)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let s=0,n=t.length;s<n;s++){const n=t[s].joints;for(let t=0,s=n.length;t<s;t++)e[n[t]].isBone=!0}for(let t=0,n=e.length;t<n;t++){const n=e[t];void 0!==n.mesh&&(this._addNodeRef(this.meshCache,n.mesh),void 0!==n.skin&&(s[n.mesh].isSkinnedMesh=!0)),void 0!==n.camera&&this._addNodeRef(this.cameraCache,n.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),r=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[s,n]of e.children.entries())r(n,t.children[s])};return r(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne((function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)})),!n)throw new Error("Unknown type: "+e)}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return s.getDependency(e,n)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[Ee.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(e,r){s.load(l.resolveURL(t.uri,n.path),e,void 0,(function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const s=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+s)}))}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse){const e=Je[n.type],t=We[n.componentType],s=!0===n.normalized,r=new t(n.count*e);return Promise.resolve(new b(r,e,s))}const r=[];return void 0!==n.bufferView?r.push(this.getDependency("bufferView",n.bufferView)):r.push(null),void 0!==n.sparse&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then((function(e){const r=e[0],o=Je[n.type],i=We[n.componentType],a=i.BYTES_PER_ELEMENT,c=a*o,l=n.byteOffset||0,u=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,h=!0===n.normalized;let d,m;if(u&&u!==c){const e=Math.floor(l/u),s="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let c=t.cache.get(s);c||(d=new i(r,e*u,n.count*u/a),c=new M(d,u/a),t.cache.add(s,c)),m=new S(c,o,l%u/a,h)}else d=null===r?new i(n.count*o):new i(r,l,n.count*o),m=new b(d,o,h);if(void 0!==n.sparse){const t=Je.SCALAR,s=We[n.sparse.indices.componentType],a=n.sparse.indices.byteOffset||0,c=n.sparse.values.byteOffset||0,l=new s(e[1],a,n.sparse.count*t),u=new i(e[2],c,n.sparse.count*o);null!==r&&(m=new b(m.array.slice(),m.itemSize,m.normalized));for(let e=0,t=l.length;e<t;e++){const t=l[e];if(m.setX(t,u[e*o]),o>=2&&m.setY(t,u[e*o+1]),o>=3&&m.setZ(t,u[e*o+2]),o>=4&&m.setW(t,u[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m}))}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e].source,r=t.images[n];let o=this.textureLoader;if(r.uri){const e=s.manager.getHandler(r.uri);null!==e&&(o=e)}return this.loadTextureImage(e,n,o)}loadTextureImage(e,t,s){const n=this,r=this.json,o=r.textures[e],i=r.images[t],a=(i.uri||i.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const c=this.loadImageSource(t,s).then((function(t){t.flipY=!1,t.name=o.name||i.name||"",""===t.name&&"string"==typeof i.uri&&!1===i.uri.startsWith("data:image/")&&(t.name=i.uri);const s=(r.samplers||{})[o.sampler]||{};return t.magFilter=Qe[s.magFilter]||L,t.minFilter=Qe[s.minFilter]||I,t.wrapS=Ze[s.wrapS]||N,t.wrapT=Ze[s.wrapT]||N,n.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[a]=c,c}loadImageSource(e,t){const s=this,n=this.json,r=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const o=n.images[e],i=self.URL||self.webkitURL;let a=o.uri||"",c=!1;if(void 0!==o.bufferView)a=s.getDependency("bufferView",o.bufferView).then((function(e){c=!0;const t=new Blob([e],{type:o.mimeType});return a=i.createObjectURL(t),a}));else if(void 0===o.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const u=Promise.resolve(a).then((function(e){return new Promise((function(s,n){let o=s;!0===t.isImageBitmapLoader&&(o=function(e){const t=new ae(e);t.needsUpdate=!0,s(t)}),t.load(l.resolveURL(e,r.path),o,void 0,n)}))})).then((function(e){var t;return!0===c&&i.revokeObjectURL(a),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e}));return this.sourceCache[e]=u,u}assignTexture(e,t,s,n){const r=this;return this.getDependency("texture",s.index).then((function(o){if(!o)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((o=o.clone()).channel=s.texCoord),r.extensions[Ee.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[Ee.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(o);o=r.extensions[Ee.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),r.associations.set(o,t)}}return void 0!==n&&(o.colorSpace=n),e[t]=o,o}))}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,o=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new O,C.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new P,C.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,this.cache.add(e,t)),s=t}if(n||r||o){let e="ClonedMaterial:"+s.uuid+":";n&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),r&&(t.vertexColors=!0),o&&(t.flatShading=!0),n&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}e.material=s}getMaterialType(){return H}loadMaterial(e){const t=this,s=this.json,n=this.extensions,r=s.materials[e];let o;const i={},a=[];if((r.extensions||{})[Ee.KHR_MATERIALS_UNLIT]){const e=n[Ee.KHR_MATERIALS_UNLIT];o=e.getMaterialType(),a.push(e.extendParams(i,r,t))}else{const s=r.pbrMetallicRoughness||{};if(i.color=new h(1,1,1),i.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;i.color.fromArray(e),i.opacity=e[3]}void 0!==s.baseColorTexture&&a.push(t.assignTexture(i,"map",s.baseColorTexture,g)),i.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,i.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(a.push(t.assignTexture(i,"metalnessMap",s.metallicRoughnessTexture)),a.push(t.assignTexture(i,"roughnessMap",s.metallicRoughnessTexture))),o=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),a.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,i)}))))}!0===r.doubleSided&&(i.side=k);const c=r.alphaMode||st;if(c===rt?(i.transparent=!0,i.depthWrite=!1):(i.transparent=!1,c===nt&&(i.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&o!==f&&(a.push(t.assignTexture(i,"normalMap",r.normalTexture)),i.normalScale=new T(1,1),void 0!==r.normalTexture.scale)){const e=r.normalTexture.scale;i.normalScale.set(e,e)}return void 0!==r.occlusionTexture&&o!==f&&(a.push(t.assignTexture(i,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(i.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&o!==f&&(i.emissive=(new h).fromArray(r.emissiveFactor)),void 0!==r.emissiveTexture&&o!==f&&a.push(t.assignTexture(i,"emissiveMap",r.emissiveTexture,g)),Promise.all(a).then((function(){const s=new o(i);return r.name&&(s.name=r.name),it(s,r),t.associations.set(s,{materials:e}),r.extensions&&ot(n,s,r),s}))}createUniqueName(e){const t=D.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function r(e){return s[Ee.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(s){return mt(s,e,t)}))}const o=[];for(let s=0,i=e.length;s<i;s++){const i=e[s],a=ct(i),c=n[a];if(c)o.push(c.promise);else{let e;e=i.extensions&&i.extensions[Ee.KHR_DRACO_MESH_COMPRESSION]?r(i):mt(new F,i,t),n[a]={primitive:i,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){const t=this,s=this.json,n=this.extensions,r=s.meshes[e],o=r.primitives,c=[];for(let e=0,t=o.length;e<t;e++){const t=void 0===o[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new H({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:ie})),l.DefaultMaterial):this.getDependency("material",o[e].material);c.push(t)}var l;return c.push(t.loadGeometries(o)),Promise.all(c).then((function(s){const c=s.slice(0,s.length-1),l=s[s.length-1],u=[];for(let s=0,h=l.length;s<h;s++){const h=l[s],d=o[s];let m;const p=c[s];if(d.mode===Ye.TRIANGLES||d.mode===Ye.TRIANGLE_STRIP||d.mode===Ye.TRIANGLE_FAN||void 0===d.mode)m=!0===r.isSkinnedMesh?new B(h,p):new G(h,p),!0===m.isSkinnedMesh&&m.normalizeSkinWeights(),d.mode===Ye.TRIANGLE_STRIP?m.geometry=xe(m.geometry,a):d.mode===Ye.TRIANGLE_FAN&&(m.geometry=xe(m.geometry,i));else if(d.mode===Ye.LINES)m=new U(h,p);else if(d.mode===Ye.LINE_STRIP)m=new j(h,p);else if(d.mode===Ye.LINE_LOOP)m=new K(h,p);else{if(d.mode!==Ye.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+d.mode);m=new V(h,p)}Object.keys(m.geometry.morphAttributes).length>0&&at(m,r),m.name=t.createUniqueName(r.name||"mesh_"+e),it(m,r),d.extensions&&ot(n,m,d),t.assignFinalMaterial(m),u.push(m)}for(let s=0,n=u.length;s<n;s++)t.associations.set(u[s],{meshes:e,primitives:s});if(1===u.length)return r.extensions&&ot(n,u[0],r),u[0];const h=new X;r.extensions&&ot(n,h,r),t.associations.set(h,{meshes:e});for(let e=0,t=u.length;e<t;e++)h.add(u[e]);return h}))}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?t=new q(z.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new Y(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),it(t,s),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],s=[];for(let e=0,n=t.joints.length;e<n;e++)s.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then((function(e){const s=e.pop(),n=e,r=[],o=[];for(let e=0,i=n.length;e<i;e++){const i=n[e];if(i){r.push(i);const t=new x;null!==s&&t.fromArray(s.array,16*e),o.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}return new W(r,o)}))}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],r=n.name?n.name:"animation_"+e,o=[],i=[],a=[],c=[],l=[];for(let e=0,t=n.channels.length;e<t;e++){const t=n.channels[e],s=n.samplers[t.sampler],r=t.target,u=r.node,h=void 0!==n.parameters?n.parameters[s.input]:s.input,d=void 0!==n.parameters?n.parameters[s.output]:s.output;void 0!==r.node&&(o.push(this.getDependency("node",u)),i.push(this.getDependency("accessor",h)),a.push(this.getDependency("accessor",d)),c.push(s),l.push(r))}return Promise.all([Promise.all(o),Promise.all(i),Promise.all(a),Promise.all(c),Promise.all(l)]).then((function(e){const t=e[0],n=e[1],o=e[2],i=e[3],a=e[4],c=[];for(let e=0,r=t.length;e<r;e++){const r=t[e],l=n[e],u=o[e],h=i[e],d=a[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();const m=s._createAnimationTracks(r,l,u,h,d);if(m)for(let e=0;e<m.length;e++)c.push(m[e])}return new Q(r,void 0,c)}))}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return void 0===n.mesh?null:s.getDependency("mesh",n.mesh).then((function(e){const t=s._getNodeRef(s.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,s=n.weights.length;t<s;t++)e.morphTargetInfluences[t]=n.weights[t]})),t}))}loadNode(e){const t=this,s=this.json.nodes[e],n=t._loadNodeShallow(e),r=[],o=s.children||[];for(let e=0,s=o.length;e<s;e++)r.push(t.getDependency("node",o[e]));const i=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([n,Promise.all(r),i]).then((function(e){const t=e[0],s=e[1],n=e[2];null!==n&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(n,ht)}));for(let e=0,n=s.length;e<n;e++)t.add(s[e]);return t}))}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const r=t.nodes[e],o=r.name?n.createUniqueName(r.name):"",i=[],a=n._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return a&&i.push(a),void 0!==r.camera&&i.push(n.getDependency("camera",r.camera).then((function(e){return n._getNodeRef(n.cameraCache,r.camera,e)}))),n._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){i.push(e)})),this.nodeCache[e]=Promise.all(i).then((function(t){let i;if(i=!0===r.isBone?new Z:t.length>1?new X:1===t.length?t[0]:new _,i!==t[0])for(let e=0,s=t.length;e<s;e++)i.add(t[e]);if(r.name&&(i.userData.name=r.name,i.name=o),it(i,r),r.extensions&&ot(s,i,r),void 0!==r.matrix){const e=new x;e.fromArray(r.matrix),i.applyMatrix4(e)}else void 0!==r.translation&&i.position.fromArray(r.translation),void 0!==r.rotation&&i.quaternion.fromArray(r.rotation),void 0!==r.scale&&i.scale.fromArray(r.scale);return n.associations.has(i)||n.associations.set(i,{}),n.associations.get(i).nodes=e,i})),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,r=new X;s.name&&(r.name=n.createUniqueName(s.name)),it(r,s),s.extensions&&ot(t,r,s);const o=s.nodes||[],i=[];for(let e=0,t=o.length;e<t;e++)i.push(n.getDependency("node",o[e]));return Promise.all(i).then((function(e){for(let t=0,s=e.length;t<s;t++)r.add(e[t]);return n.associations=(e=>{const t=new Map;for(const[e,s]of n.associations)(e instanceof C||e instanceof ae)&&t.set(e,s);return e.traverse((e=>{const s=n.associations.get(e);null!=s&&t.set(e,s)})),t})(r),r}))}_createAnimationTracks(e,t,s,n,r){const o=[],i=e.name?e.name:e.uuid,a=[];let c;switch(et[r.path]===et.weights?e.traverse((function(e){e.morphTargetInfluences&&a.push(e.name?e.name:e.uuid)})):a.push(i),et[r.path]){case et.weights:c=le;break;case et.rotation:c=ue;break;case et.position:case et.scale:c=ce;break;default:if(1===s.itemSize)c=le;else c=ce}const l=void 0!==n.interpolation?tt[n.interpolation]:J,u=this._getArrayFromAccessor(s);for(let e=0,s=a.length;e<s;e++){const s=new c(a[e]+"."+et[r.path],t.array,u,l);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(s),o.push(s)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=ut(t.constructor),s=new Float32Array(t.length);for(let n=0,r=t.length;n<r;n++)s[n]=t[n]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof ue?ze:Xe)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function mt(e,t,s){const n=t.attributes,r=[];function o(t,n){return s.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(const t in n){const s=$e[t]||t.toLowerCase();s in e.attributes||r.push(o(n[t],s))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));r.push(n)}return it(e,t),function(e,t,s){const n=t.attributes,r=new he;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],t=e.min,o=e.max;if(void 0===t||void 0===o)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(r.set(new R(t[0],t[1],t[2]),new R(o[0],o[1],o[2])),e.normalized){const t=ut(We[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const o=t.targets;if(void 0!==o){const e=new R,t=new R;for(let n=0,r=o.length;n<r;n++){const r=o[n];if(void 0!==r.POSITION){const n=s.json.accessors[r.POSITION],o=n.min,i=n.max;if(void 0!==o&&void 0!==i){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(i[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(i[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(i[2]))),n.normalized){const e=ut(We[n.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}r.expandByVector(e)}e.boundingBox=r;const i=new de;r.getCenter(i.center),i.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=i}(e,t,s),Promise.all(r).then((function(){return void 0!==t.targets?function(e,t,s){let n=!1,r=!1,o=!1;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(void 0!==s.POSITION&&(n=!0),void 0!==s.NORMAL&&(r=!0),void 0!==s.COLOR_0&&(o=!0),n&&r&&o)break}if(!n&&!r&&!o)return Promise.resolve(e);const i=[],a=[],c=[];for(let l=0,u=t.length;l<u;l++){const u=t[l];if(n){const t=void 0!==u.POSITION?s.getDependency("accessor",u.POSITION):e.attributes.position;i.push(t)}if(r){const t=void 0!==u.NORMAL?s.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){const t=void 0!==u.COLOR_0?s.getDependency("accessor",u.COLOR_0):e.attributes.color;c.push(t)}}return Promise.all([Promise.all(i),Promise.all(a),Promise.all(c)]).then((function(t){const s=t[0],i=t[1],a=t[2];return n&&(e.morphAttributes.position=s),r&&(e.morphAttributes.normal=i),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e}))}(e,t.targets,s):e}))}var pt=new class extends c{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new ye(e)})),this.register((function(e){return new Ce(e)})),this.register((function(e){return new Pe(e)})),this.register((function(e){return new He(e)})),this.register((function(e){return new Me(e)})),this.register((function(e){return new Se(e)})),this.register((function(e){return new Le(e)})),this.register((function(e){return new Ie(e)})),this.register((function(e){return new we(e)})),this.register((function(e){return new Ne(e)})),this.register((function(e){return new be(e)})),this.register((function(e){return new Oe(e)})),this.register((function(e){return new ve(e)})),this.register((function(e){return new ke(e)})),this.register((function(e){return new De(e)}))}load(e,t,s,n){const r=this;let o;o=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:l.extractUrlBase(e),this.manager.itemStart(e);const i=function(t){n?n(t):console.error(t),r.manager.itemError(e),r.manager.itemEnd(e)},a=new u(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(function(s){try{r.parse(s,o,(function(s){t(s),r.manager.itemEnd(e)}),i)}catch(e){i(e)}}),s,i)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let r;const o={},i={},a=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer){if(a.decode(new Uint8Array(e,0,4))===Fe){try{o[Ee.KHR_BINARY_GLTF]=new Ue(e)}catch(e){return void(n&&n(e))}r=JSON.parse(o[Ee.KHR_BINARY_GLTF].content)}else r=JSON.parse(a.decode(e))}else r=e;if(void 0===r.asset||r.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const c=new dt(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](c);i[t.name]=t,o[t.name]=!0}if(r.extensionsUsed)for(let e=0;e<r.extensionsUsed.length;++e){const t=r.extensionsUsed[e],s=r.extensionsRequired||[];switch(t){case Ee.KHR_MATERIALS_UNLIT:o[t]=new _e;break;case Ee.KHR_DRACO_MESH_COMPRESSION:o[t]=new je(r,this.dracoLoader);break;case Ee.KHR_TEXTURE_TRANSFORM:o[t]=new Ke;break;case Ee.KHR_MESH_QUANTIZATION:o[t]=new Ve;break;default:s.indexOf(t)>=0&&void 0===i[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}c.setExtensions(o),c.setPlugins(i),c.parse(s,n)}parseAsync(e,t){const s=this;return new Promise((function(n,r){s.parse(e,t,n,r)}))}};function ft(o){var i=t(),a=s(),c=a[0],l=a[1],u=s(),h=u[0],d=u[1],m=s(),p=m[0],f=m[1],g=s([]),A=g[0],T=g[1],x=s([0,0,0]),R=x[0],E=x[1],v=s(!1),w=v[0],y=v[1],b=s(!1);b[0];var M=b[1],S=s(!1),L=S[0],I=S[1],N=s(!1),O=N[0],C=N[1],P=fe({position:w&&i?R:o.position,config:ge.slow}).position;return n((function(){if(o.data.isMonitored){M(!0);var e=o.statuses.find((function(e){return e.signature===o.data.status}));d(e),l(e),o.debug&&console.log("[DEBUG] Monitoring animation for ["+o.data.name+"] was configured")}}),[o.data.status]),n((function(){o.data&&(o.debug&&console.log("[DEBUG] Creating Modular Mesh for ["+o.data.name+"]"),o.data.isMovable&&(M(!0),o.data.travelV3&&E([o.position[0]+o.data.travelV3[0],o.position[1]+o.data.travelV3[1],o.position[2]+o.data.travelV3[2]]),o.data.isMovedByDefault&&y(o.data.isMovedByDefault),o.debug&&console.log("[DEBUG] Movement animation for ["+o.data.name+"] was configured")),pt.load(o.data.path,(function(e){if(f(e.scene),o.data.isParent){var t=new Array;e.scene.children.map((function(e){"Object3D"===e.type&&t.push({position:e.position,slot:e.name})})),T(t),o.debug&&console.log("[DEBUG] Found "+t.length+" slots in ["+o.data.name+"]")}o.debug&&console.log("[DEBUG] Created Modular Mesh for ["+o.data.name+"]")}),(function(e){})))}),[]),n((function(){i.current.traverse((function(e){e.material&&e.material.emissive&&(e.material.emissive.setRGB(0,0,0),e.material.needsUpdate=!1)})),L&&l(o.selectionEffect)}),[L,o.data.status]),n((function(){o.data&&o.selection&&L&&o.selection.get!==o.data&&(I(!1),l(h),o.debug&&console.log("[Debug] Unselect on "+o.data.name))}),[o.selection&&o.selection.get]),n((function(){return O&&(o.data.isSelectable&&(document.body.style.cursor="help"),o.data.isMovable&&(document.body.style.cursor="grab")),function(){document.body.style.cursor="auto"}}),[O]),pe((function(e,t){if(i&&c&&i.current&&c.displayMode)switch(c.displayMode){case"blink":c.speed&&c.targetRGB&&i.current.traverse((function(t){c.speed&&c.targetRGB&&t.material&&t.material.emissive&&Math.sin(e.clock.getElapsedTime()*c.speed)>0&&(t.material.emissive.setRGB(Math.sin(e.clock.getElapsedTime()*c.speed)*c.targetRGB[0],Math.sin(e.clock.getElapsedTime()*c.speed)*c.targetRGB[1],Math.sin(e.clock.getElapsedTime()*c.speed)*c.targetRGB[2]),t.material.needsUpdate=!0)}));break;case"fade":c.speed&&c.targetRGB&&i.current.traverse((function(t){c.speed&&c.targetRGB&&t.material&&t.material.emissive&&(t.material.emissive.setRGB((.5*Math.sin(e.clock.getElapsedTime()*c.speed)+.5)*c.targetRGB[0],(.5*Math.sin(e.clock.getElapsedTime()*c.speed)+.5)*c.targetRGB[1],(.5*Math.sin(e.clock.getElapsedTime()*c.speed)+.5)*c.targetRGB[2]),t.material.needsUpdate=!0)}));break;default:i.current.traverse((function(e){c.targetRGB&&e.material&&e.material.emissive&&(e.material.emissive.setRGB(c.targetRGB[0],c.targetRGB[1],c.targetRGB[2]),e.material.needsUpdate=!1)}))}})),e.createElement(Ae.group,Te({},o,{position:P,onClick:function(e){var t;e.stopPropagation(),e.delta>0||(null===(t=o.selection)||void 0===t?void 0:t.get)===o.data||o.data&&!o.data.isSelectable||(I(!L),r((function(){o.selection&&o.selection.set(o.data)})))},onDoubleClick:function(e){o.data.isMovable&&y(!w),e.stopPropagation()},onPointerOver:function(e){e.stopPropagation(),C(!0)},onPointerOut:function(e){e.stopPropagation(),C(!1)}}),e.createElement("primitive",{object:p||new _,ref:i}),o.data.components&&A.map((function(t,s){var n,r=null===(n=o.data.components)||void 0===n?void 0:n.find((function(e){return t.slot===e.slot}));if(r)return e.createElement(ft,Te({},o,{data:r,position:t.position.toArray(),key:s}))})))}function gt(t){var r=s(null),o=r[0],i=r[1],a=s({displayMode:"blink",targetRGB:[0,.19,.2],speed:10}),c=a[0],l=a[1];return n((function(){t.selection&&t.selection(o)}),[o]),n((function(){t.selectionEffect&&l(t.selectionEffect)}),[]),e.createElement(e.Fragment,null,e.createElement("group",{position:t.position,onPointerMissed:function(){o&&i(null)}},t.models&&t.models.map((function(s,n){return e.createElement(ft,Te({},t,{debug:void 0!==t.debug&&t.debug,selection:{get:o,set:i},selectionEffect:c,data:s,position:[0,0,0],key:n}))}))))}export{gt as ModularBuilder,ft as ModularMesh};
//# sourceMappingURL=index.js.map
